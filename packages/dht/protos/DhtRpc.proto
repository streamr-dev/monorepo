syntax = "proto3";
option optimize_for = CODE_SIZE;

package dht;

import "google/protobuf/empty.proto";
import "google/protobuf/any.proto";
import "google/protobuf/timestamp.proto";
import "packages/proto-rpc/protos/ProtoRpc.proto";

service DhtRpcService {
  rpc getClosestPeers (ClosestPeersRequest) returns (ClosestPeersResponse);
  rpc ping (PingRequest) returns (PingResponse);
  rpc leaveNotice (LeaveNotice) returns (google.protobuf.Empty);
}

service RoutingService {
  rpc routeMessage (RouteMessageWrapper) returns (RouteMessageAck);
  rpc forwardMessage (RouteMessageWrapper) returns (RouteMessageAck);
  rpc findRecursively (RouteMessageWrapper) returns (RouteMessageAck);
}

service StoreService {
  rpc storeData (StoreDataRequest) returns (StoreDataResponse);
  rpc migrateData (MigrateDataRequest) returns (MigrateDataResponse);
}

service RecursiveFindSessionService {
  rpc reportRecursiveFindResult(RecursiveFindReport) returns (google.protobuf.Empty);
}

service WebSocketConnectorService {
  rpc requestConnection (WebSocketConnectionRequest) returns (WebSocketConnectionResponse);
}

service WebRtcConnectorService {
  rpc requestConnection (WebRtcConnectionRequest) returns (google.protobuf.Empty);
  rpc rtcOffer (RtcOffer) returns (google.protobuf.Empty);
  rpc rtcAnswer (RtcAnswer) returns (google.protobuf.Empty);
  rpc iceCandidate (IceCandidate) returns (google.protobuf.Empty);
}

service ConnectionLocker {
  rpc lockRequest (LockRequest) returns (LockResponse);
  rpc unlockRequest (UnlockRequest) returns (google.protobuf.Empty);
  rpc gracefulDisconnect (DisconnectNotice) returns (DisconnectNoticeResponse);
}

service ExternalApiService {
  rpc findData (FindDataRequest) returns (FindDataResponse);
}

// Used inside RpcMessage

message StoreDataRequest {
  bytes kademliaId = 1;
  google.protobuf.Any data = 2;
  uint32 ttl = 3;
}

message StoreDataResponse {
  string error = 1;
}

message MigrateDataRequest {
  DataEntry dataEntry = 1;
}
  
message MigrateDataResponse {
  string error = 1;
}

message DataEntry {
  PeerDescriptor storer = 1;
  bytes kademliaId = 2;
  google.protobuf.Any data = 3;
  google.protobuf.Timestamp storedAt = 4; 
  uint32 ttl = 5;   // milliseconds
  bool stale = 6;
}

message ClosestPeersRequest {
  bytes kademliaId = 1;
  string requestId = 2;
}

message ClosestPeersResponse {
  repeated PeerDescriptor peers = 1;
  string requestId = 2;
}

enum FindMode {
  NODE = 0;
  DATA = 1;
}

message RecursiveFindRequest {
  string recursiveFindSessionId = 1;
  FindMode findMode = 2;
}

message RecursiveFindReport {
  repeated PeerDescriptor nodes = 1;
  repeated DataEntry dataEntries = 2;
  optional bool noCloserNodesFound = 3;
  repeated PeerDescriptor routingPath = 4;
}

message PingRequest {
  string requestId = 1;
}

message PingResponse {
  string requestId = 1;
}

message LeaveNotice {
  string serviceId = 1;
}

message PeerDescriptor {
  bytes kademliaId = 1;
  NodeType type = 2;
  ConnectivityMethod udp = 3;
  ConnectivityMethod tcp = 4;
  ConnectivityMethod websocket = 5;
  optional bool openInternet = 6;
  optional uint32 region = 7;
  optional string nodeName = 8;
}

message ConnectivityMethod {
  uint32 port = 2;
  string ip = 3;
}

enum NodeType {
  NODEJS = 0;
  BROWSER = 1;
  VIRTUAL = 3;
}

message ConnectivityReportRequest {
  uint32 port = 1;
  string requestId = 2;
}

message ConnectivityReportResponse {
  string open_internet = 1;
  string ip = 2;
  string natType = 3;
  string requestId = 4;
}

enum RpcResponseError {
  SERVER_TIMOUT = 0;
  CLIENT_TIMEOUT = 1;
  SERVER_ERROR = 2;
  UNKNOWN_RPC_METHOD = 3;
}

message RouteMessageWrapper {
  PeerDescriptor sourcePeer = 1;
  string requestId = 2;
  PeerDescriptor destinationPeer = 3;
  PeerDescriptor previousPeer = 4;
  Message message = 5;
  repeated PeerDescriptor reachableThrough = 6;
  repeated PeerDescriptor routingPath = 7;
}

message RouteMessageAck {
  PeerDescriptor sourcePeer = 1;
  string requestId = 2;
  PeerDescriptor destinationPeer = 3;
  string error = 4;
}

// Correspond to the MessageType Enum

message ConnectivityRequest {
  uint32 port = 1;
}

message ConnectivityResponse {
  bool open_internet = 1;
  string ip = 2;
  string natType = 3;
  ConnectivityMethod websocket = 4;
}

message HandshakeRequest {
  bytes sourceId = 1;
  string protocolVersion = 2;
  PeerDescriptor peerDescriptor = 3;
}

message HandshakeResponse {
  bytes sourceId = 1;
  string protocolVersion = 2;
  PeerDescriptor peerDescriptor = 3;
  optional string responseError = 4;
}

// Wraps all messages

enum MessageType {
  CONNECTIVITY_REQUEST = 0;
  CONNECTIVITY_RESPONSE = 1;
  HANDSHAKE_REQUEST = 2;
  HANDSHAKE_RESPONSE = 3;
  RPC = 4;
  RECURSIVE_FIND_REQUEST = 5;
}

message Message {
  string messageId = 1;
  MessageType messageType = 2;
  PeerDescriptor sourceDescriptor = 3;
  PeerDescriptor targetDescriptor = 4;
  string serviceId = 5; // id of the RPC service
  oneof body {
    ConnectivityRequest connectivityRequest = 6;
    ConnectivityResponse connectivityResponse = 7;
    HandshakeRequest handshakeRequest = 8;
    HandshakeResponse handshakeResponse = 9;
    protorpc.RpcMessage rpcMessage = 10;
    RecursiveFindRequest RecursiveFindRequest = 11;
  };
}

// Connector Messages

// WebSocket
message WebSocketConnectionRequest {
  PeerDescriptor requester = 1;
  PeerDescriptor target = 2;
  string ip = 3;
  uint32 port = 4;
}

message WebSocketConnectionResponse {
  PeerDescriptor requester = 1;
  PeerDescriptor target = 2;
  bool accepted = 3;
  optional string reason = 4;
}

// WebRTC
message WebRtcConnectionRequest {
  PeerDescriptor requester = 1;
  PeerDescriptor target = 2;
  string connectionId = 3;
}

message RtcOffer {
  PeerDescriptor requester = 1;
  PeerDescriptor target = 2;
  string description = 3;
  string connectionId = 4;
}

message RtcAnswer {
  PeerDescriptor requester = 1;
  PeerDescriptor target = 2;
  string description = 3;
  string connectionId = 4;
}

message IceCandidate {
  string candidate = 1;
  string mid = 2;
  string connectionId = 3;
  PeerDescriptor requester = 4;
  PeerDescriptor target = 5;
}

message LockRequest {
  string protocolVersion = 1;
  PeerDescriptor peerDescriptor = 2;
  string serviceId = 3;
}

message UnlockRequest {
  string protocolVersion = 1;
  PeerDescriptor peerDescriptor = 2;
  string serviceId = 3;
}

message LockResponse {
  bool accepted = 1;
  optional bool reason = 2;
}

enum DisconnectMode {
  NORMAL = 0;
  LEAVING = 1;
}

message DisconnectNotice {
  string protocolVersion = 1;
  PeerDescriptor peerDescriptor = 2;
  DisconnectMode disconnecMode = 3;
}

message DisconnectNoticeResponse {
  string protocolVersion = 1;
}

message FindDataRequest {
  bytes kademliaId = 1;
  PeerDescriptor requestor = 2;
}

message FindDataResponse {
  repeated DataEntry dataEntries = 1;
  optional string error = 2;
}