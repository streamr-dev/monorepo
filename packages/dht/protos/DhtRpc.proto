syntax = "proto3";
option optimize_for = CODE_SIZE;

package dht;

import "google/protobuf/empty.proto";
import "google/protobuf/any.proto";
import "google/protobuf/timestamp.proto";
import "packages/proto-rpc/protos/ProtoRpc.proto";

service DhtNodeRpc {
  rpc getClosestPeers (ClosestPeersRequest) returns (ClosestPeersResponse);
  rpc ping (PingRequest) returns (PingResponse);
  rpc leaveNotice (LeaveNotice) returns (google.protobuf.Empty);
}

service RouterRpc {
  rpc routeMessage (RouteMessageWrapper) returns (RouteMessageAck);
  rpc forwardMessage (RouteMessageWrapper) returns (RouteMessageAck);
}

service FindRpc {
  rpc routeFindRequest (RouteMessageWrapper) returns (RouteMessageAck);
}

service StoreRpc {
  rpc storeData (StoreDataRequest) returns (StoreDataResponse);
  rpc replicateData (ReplicateDataRequest) returns (google.protobuf.Empty);
}

service FindSessionRpc {
  rpc sendFindResponse(FindResponse) returns (google.protobuf.Empty);
}

service WebsocketConnectorRpc {
  rpc requestConnection (WebsocketConnectionRequest) returns (WebsocketConnectionResponse);
}

service WebrtcConnectorRpc {
  rpc requestConnection (WebrtcConnectionRequest) returns (google.protobuf.Empty);
  rpc rtcOffer (RtcOffer) returns (google.protobuf.Empty);
  rpc rtcAnswer (RtcAnswer) returns (google.protobuf.Empty);
  rpc iceCandidate (IceCandidate) returns (google.protobuf.Empty);
}

service ConnectionLockRpc {
  rpc lockRequest (LockRequest) returns (LockResponse);
  rpc unlockRequest (UnlockRequest) returns (google.protobuf.Empty);
  rpc gracefulDisconnect (DisconnectNotice) returns (DisconnectNoticeResponse);
}

service ExternalApiRpc {
  rpc externalFindData (ExternalFindDataRequest) returns (ExternalFindDataResponse);
  rpc externalStoreData (ExternalStoreDataRequest) returns (ExternalStoreDataResponse);
}

// Used inside RpcMessage

message StoreDataRequest {
  bytes key = 1;
  google.protobuf.Any data = 2;
  PeerDescriptor creator = 3;
  google.protobuf.Timestamp createdAt = 4;
  uint32 ttl = 5;
}

message StoreDataResponse {
  string error = 1;
}

message ExternalStoreDataRequest {
  bytes key = 1;
  google.protobuf.Any data = 2;
}

message ExternalStoreDataResponse {
  repeated PeerDescriptor storers = 1;
}

message ReplicateDataRequest {
  DataEntry entry = 1;
}

message DataEntry {
  bytes key = 1;
  google.protobuf.Any data = 2;
  PeerDescriptor creator = 3;
  google.protobuf.Timestamp createdAt = 4;
  google.protobuf.Timestamp storedAt = 5; 
  uint32 ttl = 6;   // milliseconds
  bool stale = 7;
  bool deleted = 8;
}

message ClosestPeersRequest {
  bytes nodeId = 1;
  string requestId = 2;
}

message ClosestPeersResponse {
  repeated PeerDescriptor peers = 1;
  string requestId = 2;
}

message FindRequest {
  string sessionId = 1;
  RecursiveOperation operation = 2;
}

enum RecursiveOperation {
  FIND_NODE = 0;
  FETCH_DATA = 1;
  DELETE_DATA = 2;
}

message FindResponse {
  repeated PeerDescriptor closestConnectedPeers = 1;
  repeated DataEntry dataEntries = 2;
  bool noCloserNodesFound = 3;
  repeated PeerDescriptor routingPath = 4;
}

message PingRequest {
  string requestId = 1;
}

message PingResponse {
  string requestId = 1;
}

message LeaveNotice {
  string serviceId = 1;
}

message PeerDescriptor {
  bytes nodeId = 1;
  NodeType type = 2;
  ConnectivityMethod udp = 3;
  ConnectivityMethod tcp = 4;
  ConnectivityMethod websocket = 5;
  optional uint32 region = 6;
}

message ConnectivityMethod {
  uint32 port = 1;
  string host = 2;
  bool tls = 3;
}

enum NodeType {
  NODEJS = 0;
  BROWSER = 1;
  VIRTUAL = 3;
}

enum RpcResponseError {
  SERVER_TIMOUT = 0;
  CLIENT_TIMEOUT = 1;
  SERVER_ERROR = 2;
  UNKNOWN_RPC_METHOD = 3;
}

message RouteMessageWrapper {
  PeerDescriptor sourcePeer = 1;
  string requestId = 2;
  PeerDescriptor destinationPeer = 3;
  Message message = 4;
  repeated PeerDescriptor reachableThrough = 5;
  repeated PeerDescriptor routingPath = 6;
}

message RouteMessageAck {
  string requestId = 1;
  optional RouteMessageError error = 2;
}

enum RouteMessageError {
  NO_TARGETS = 0;
  DUPLICATE = 1;
  // TODO: can this be removed? If DhtNode is already stopped the server side requests
  // should not be processed
  STOPPED = 2;
}

// Correspond to the MessageType Enum

message ConnectivityRequest {
  uint32 port = 1;
  bool tls = 2;
  optional string host = 3;
  bool selfSigned = 4;
}

message ConnectivityResponse {
  string host = 1;
  string natType = 2;
  ConnectivityMethod websocket = 3;
}

message HandshakeRequest {
  PeerDescriptor sourcePeerDescriptor = 1;
  optional PeerDescriptor targetPeerDescriptor = 2;
}

message HandshakeResponse {
  PeerDescriptor sourcePeerDescriptor = 1;
  optional HandshakeError error = 2;
}

enum HandshakeError {
  DUPLICATE_CONNECTION = 0;
  INVALID_TARGET_PEER_DESCRIPTOR = 1;
}

// Wraps all messages

enum MessageType {
  RPC = 0;
  CONNECTIVITY_REQUEST = 1;
  CONNECTIVITY_RESPONSE = 2;
  HANDSHAKE_REQUEST = 3;
  HANDSHAKE_RESPONSE = 4;
  FIND_REQUEST = 5;
}

message Message {
  string messageId = 1;
  MessageType messageType = 2;
  PeerDescriptor sourceDescriptor = 3;
  PeerDescriptor targetDescriptor = 4;
  string serviceId = 5; // id of the RPC service
  oneof body {
    ConnectivityRequest connectivityRequest = 6;
    ConnectivityResponse connectivityResponse = 7;
    HandshakeRequest handshakeRequest = 8;
    HandshakeResponse handshakeResponse = 9;
    protorpc.RpcMessage rpcMessage = 10;
    FindRequest findRequest = 11;
  };
}

// Connector Messages

// WebSocket
message WebsocketConnectionRequest {
}

message WebsocketConnectionResponse {
  bool accepted = 1;
}

// WebRTC
message WebrtcConnectionRequest {
}

message RtcOffer {
  string description = 1;
  string connectionId = 2;
}

message RtcAnswer {
  string description = 1;
  string connectionId = 2;
}

message IceCandidate {
  string candidate = 1;
  string mid = 2;
  string connectionId = 3;
}

message LockRequest {
  string lockId = 1;
}

message UnlockRequest {
  string lockId = 1;
}

message LockResponse {
  bool accepted = 1;
}

enum DisconnectMode {
  NORMAL = 0;
  LEAVING = 1;
}

message DisconnectNotice {
  DisconnectMode disconnectMode = 1;
}

message DisconnectNoticeResponse {
}

message ExternalFindDataRequest {
  bytes key = 1;
}

message ExternalFindDataResponse {
  repeated DataEntry entries = 1;
}
